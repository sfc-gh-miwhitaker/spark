# Demo Expiration Workflow
# Author: SE Community
# Purpose: Auto-archive and make private after expiration date
#
# This workflow runs daily and checks if the demo has expired.
# After expiration, it archives the repository and makes it private.

name: Demo Expiration Check

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

env:
  EXPIRATION_DATE: '2026-02-15'

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: Check if demo has expired
        id: check
        run: |
          CURRENT_DATE=$(date +%Y-%m-%d)
          if [[ "$CURRENT_DATE" > "${{ env.EXPIRATION_DATE }}" ]] || [[ "$CURRENT_DATE" == "${{ env.EXPIRATION_DATE }}" ]]; then
            echo "expired=true" >> $GITHUB_OUTPUT
            echo "::warning::Demo has expired as of ${{ env.EXPIRATION_DATE }}"
          else
            echo "expired=false" >> $GITHUB_OUTPUT
            echo "Demo is still active. Expires: ${{ env.EXPIRATION_DATE }}"
          fi

      - name: Archive repository (if expired)
        if: steps.check.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Archive the repository
            await github.rest.repos.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              archived: true
            });
            console.log('Repository has been archived due to expiration.');

      # Note: Making repository private requires admin token with repo scope
      # Uncomment and configure PAT if private transition is needed
      # - name: Make repository private (if expired)
      #   if: steps.check.outputs.expired == 'true'
      #   uses: actions/github-script@v7
      #   with:
      #     github-token: ${{ secrets.ADMIN_TOKEN }}
      #     script: |
      #       await github.rest.repos.update({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         private: true
      #       });
